{% extends 'base.html' %}
{% block title %}
    <title>天天生鲜-提交订单</title>
{% endblock %}
{% block top %}
<div class="search_bar clearfix">
		<a href="/" class="logo fl"><img src="/static/images/logo.png"></a>
		<div class="sub_page_name fl">|&nbsp;&nbsp;&nbsp;&nbsp;提交订单</div>
		<div class="search_con fr">
            <form method="get" action="{% url 'goods:search' %}">
			<input type="text" class="input_text fl" name="fruit" placeholder="搜索商品">
			<input type="button" class="input_btn fr" name="" value="搜索">
        </form>
		</div>
	</div>
{% endblock %}
{% block content %}

	<h3 class="common_title">确认收货地址</h3>

	<div class="common_list_con clearfix">
		<dl>
			<dt>寄送到：</dt>
        {% for ad in addr %}
			<dd><input type="radio" name="addr_id" value="{{ ad.id }}" {% if ad.is_default %}checked{% endif %}>{{ ad.addr }} （{{ ad.receiver }} 收） {{ ad.phone }}</dd>
            {% empty %}
        {% endfor %}
        </dl>
		<a href="{% url 'user:address' %}" class="edit_site">编辑收货地址</a>

	</div>

	<h3 class="common_title">支付方式</h3>
	<div class="common_list_con clearfix">
		<div class="pay_style_con clearfix">
			<input type="radio" name="pay_style" value="1" checked>
			<label class="cash">货到付款</label>
			<input type="radio" name="pay_style" value="2">
			<label class="weixin">微信支付</label>
			<input type="radio" name="pay_style" value="3">
			<label class="zhifubao"></label>
			<input type="radio" name="pay_style" value="4">
			<label class="bank">银行卡支付</label>
		</div>
	</div>

	<h3 class="common_title">商品列表</h3>

	<div class="common_list_con clearfix">
		<ul class="goods_list_th clearfix">
			<li class="col01">商品名称</li>
			<li class="col02">商品单位</li>
			<li class="col03">商品价格</li>
			<li class="col04">数量</li>
			<li class="col05">小计</li>
		</ul>

		<ul class="goods_list_td clearfix">
            {% for x in l %}
			<li class="col01">{{ forloop.counter }}</li>
			<li class="col02"><img src="{{ x.img.url }}"></li>
			<li class="col03">{{ x.name }} 500g</li>
			<li class="col04">500g</li>
			<li class="col05">{{ x.price }}元</li>
			<li class="col06">{{ x.count }}</li>
			<li class="col07">{{ x.cost }}元</li>
            {% endfor %}
		</ul>

	</div>

	<h3 class="common_title">总金额结算</h3>

	<div class="common_list_con clearfix">
		<div class="settle_con">

			<div class="total_goods_count">共<em>{{ s }}</em>件商品，总金额<b>{{ t }}元</b></div>
			<div class="transit">运费：<b>0.00元</b></div>
			<div class="total_pay">实付款：<b>{{ t }}元</b></div>
		</div>
	</div>

	<div class="order_submit clearfix">
        {% csrf_token %}
		<a href="javascript:;" sku_ids={{ ids }} id="order_btn">提交订单</a>
	</div>


	<div class="footer">
		<div class="foot_link">
			<a href="#">关于我们</a>
			<span>|</span>
			<a href="#">联系我们</a>
			<span>|</span>
			<a href="#">招聘人才</a>
			<span>|</span>
			<a href="#">友情链接</a>
		</div>
		<p>CopyRight © 2016 北京天天生鲜信息技术有限公司 All Rights Reserved</p>
		<p>电话：010-****888    京ICP备*******8号</p>
	</div>


	<div class="popup_con">
		<div class="popup">
			<p>订单提交成功！</p>
		</div>

		<div class="mask"></div>
	</div>



	<script type="text/javascript" src="/static/js/jquery-1.12.4.min.js"></script>
	<script type="text/javascript">
		$('#order_btn').click(function() {
            // 获取用户选择的地址id, 支付方式, 要购买的商品id字符串
            addr_id = $('input[name="addr_id"]:checked').val()
            pay_method = $('input[name="pay_style"]:checked').val()
            sku_ids = $(this).attr('sku_ids')
            csrf = $('input[name="csrfmiddlewaretoken"]').val()
            count=parseInt($('.total_goods_count>em').text())
            cost=parseFloat($('.total_goods_count>b').text()).toFixed(2)
            // alert(addr_id+":"+pay_method+':'+sku_ids)
            // 组织参数
            params = {'addr_id':addr_id, 'pay_method':pay_method, 'sku_ids':sku_ids,
                        'csrfmiddlewaretoken':csrf,'count':count,'cost':cost}
            // 发起ajax post请求，访问/order/commit, 传递的参数: addr_id pay_method, sku_ids
            $.post('/order/commit', params, function (data) {
                if (data.res == 5){
                    // 创建成功
                    localStorage.setItem('order_finish',2);
                    $('.popup_con').fadeIn('fast', function() {

                        setTimeout(function(){
                            $('.popup_con').fadeOut('fast',function(){
                                window.location.href = '/user/order/';
                            });
                        },3000)

                    });
                }
                else{
                    alert(data.errmsg)
                }
            })



		});
	</script>

{% endblock %}