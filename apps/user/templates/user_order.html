{% extends 'user_base_info.html' %}
{% block content %}
<div class="right_content clearfix">
                {% csrf_token %}
				<h3 class="common_title2">全部订单</h3>
    {% for order in obj %}
				<ul class="order_list_th w978 clearfix">
					<li class="col01">{{ order.create }}</li>
					<li class="col02" style="width: 30%">订单号:{{ order.order_no }}</li>
					<li class="col02 stress">{{ order.get_pay_way_display }}</li>
				</ul>

				<table class="order_list_table w980">
					<tbody>
						<tr>
							<td width="55%">
                                {% for good in order.ordergoods_set.all %}
								<ul class="order_goods_list clearfix">
									<li class="col01"><img src="{{ good.sku.img.url }}"></li>
									<li class="col02">{{ good.sku.price }}<em>{{ good.sku.price }}元/500g</em></li>
									<li class="col03">{{ good.count }}</li>
									<li class="col04">{{ good.price }}元</li>
								</ul>{% endfor %}

							</td>
							<td width="15%">{{ order.total }}元</td>
							<td width="15%">待支付</td>
							<td width="15%"><a href="javascript:;" order_id="{{ order.id }}" status="{{ order.status }}" class="oper_btn">{{ order.get_status_display }}</a></td>
						</tr>
					</tbody>
				</table>
    {% endfor %}
				<div class="pagenation">

                            {% if obj.has_previous %}
                            <a href="{% url 'user:user_order' %}?page={{ obj.previous_page_number }}" class="active">&lt</a>
                {% endif %}
                            {% for x in paginator %}
					        <a href="{% url 'user:user_order' %}?page={{ x.number }}" {% if x.number != obj.number %}class="active"{% endif %}>{{ x.number }}</a>

                            {% endfor %}
                {% if obj.has_next %}
                    <a href="{% url 'user:user_order' %}?page={{ obj.next_page_number }}" class="active">&gt</a>
                {% endif %}

				</div>
		</div>


{% endblock %}
{% block js %}

    <script src="/static/js/jquery-1.12.4.min.js"></script>
    <script>

    $('.oper_btn').click(function () {
       // 获取status
       status = $(this).attr('status')
       // 获取订单id
       order_id = $(this).attr('order_id')
       if (status == 1){
           // 进行支付
           csrf = $('input[name="csrfmiddlewaretoken"]').val()
           // 组织参数
           params = {'order_id':order_id, 'csrfmiddlewaretoken':csrf}
           // 发起ajax post请求，访问/order/pay, 传递参数:order_id
           $.post('/order/pay', params, function (data) {
               if (data.res == 3){
                   // 引导用户到支付页面
                   window.open(data.pay_url)
                   // 浏览器访问/order/check, 获取支付交易的结果
                   // ajax post 传递参数:order_id
                   {#$.post('/order/check', params, function (data){#}
                   {#    if (data.res == 3){#}
                   {#        alert('支付成功')#}
                   {#        // 刷新页面#}
                   {#        location.reload()#}
                   {#    }#}
                   {#    else{#}
                   {#        alert(data.errmsg)#}
                   {#    }#}
                   {#})#}
               }
               else{
                   alert(data.errmsg)
               }
           })
       }
       else if (status == 4){
           // 其他情况
           // 跳转到评价页面
           location.href = '/order/comment/'+order_id
       }
    })
    </script>
{% endblock %}